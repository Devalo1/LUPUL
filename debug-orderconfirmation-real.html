<!doctype html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ”§ Debug OrderConfirmation Real Data</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
      }
      .test-section {
        background: #f0f0f0;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”§ Debug OrderConfirmation Real Data Recovery</h1>

    <div id="testResults"></div>

    <script>
      // Test direct pentru a vedea de ce datele reale nu sunt recuperate

      function debugRealDataRecovery() {
        const results = document.getElementById("testResults");
        let html = "";

        // 1. VerificÄƒ URL OrderID
        const urlParams = new URLSearchParams(window.location.search);
        const urlOrderId =
          urlParams.get("orderId") || "LC-REAL-CLIENT-1753824541036";

        html += `<div class="test-section">
        <h3>1ï¸âƒ£ URL OrderID</h3>
        <p>OrderID din URL: <strong>${urlOrderId}</strong></p>
    </div>`;

        // 2. VerificÄƒ sessionStorage
        const sessionBackup = sessionStorage.getItem("currentOrderBackup");
        html += `<div class="test-section">
        <h3>2ï¸âƒ£ SessionStorage Check</h3>`;

        if (sessionBackup) {
          try {
            const backupData = JSON.parse(sessionBackup);
            const orderIdMatch = backupData.orderId === urlOrderId;

            html += `<p class="${orderIdMatch ? "success" : "error"}">âœ… SessionStorage backup gÄƒsit!</p>
                     <p>OrderID Ã®n backup: <strong>${backupData.orderId}</strong></p>
                     <p>OrderID match: <strong>${orderIdMatch ? "DA" : "NU"}</strong></p>
                     <p>Nume: ${backupData.customerInfo.firstName} ${backupData.customerInfo.lastName}</p>
                     <p>Email: ${backupData.customerInfo.email}</p>
                     <p>Telefon: ${backupData.customerInfo.phone}</p>
                     <p>SumÄƒ: ${backupData.amount} RON</p>`;

            // VerificÄƒ dacÄƒ emailul este real
            const isRealEmail =
              !backupData.customerInfo.email.includes("example.com") &&
              !backupData.customerInfo.email.includes("@test.com") &&
              backupData.customerInfo.email !== "client.recuperat@example.com";

            html += `<p class="${isRealEmail ? "success" : "error"}">
                     Email real: <strong>${isRealEmail ? "DA" : "NU"}</strong>
                     </p>`;
          } catch (error) {
            html += `<p class="error">âŒ Eroare parsare: ${error.message}</p>`;
          }
        } else {
          html += `<p class="error">âŒ Nu existÄƒ sessionStorage backup</p>`;
        }

        html += `</div>`;

        // 3. VerificÄƒ localStorage
        html += `<div class="test-section">
        <h3>3ï¸âƒ£ LocalStorage Check</h3>
        <p>currentOrder: ${localStorage.getItem("currentOrder") ? "EXISTÄ‚" : "LIPSÄ‚"}</p>
        <p>pendingOrder: ${localStorage.getItem("pendingOrder") ? "EXISTÄ‚" : "LIPSÄ‚"}</p>
        <p>pendingOrders: ${localStorage.getItem("pendingOrders") ? "EXISTÄ‚" : "LIPSÄ‚"}</p>
    </div>`;

        // 4. SimuleazÄƒ recuperarea datelor exact ca Ã®n OrderConfirmation
        html += `<div class="test-section">
        <h3>4ï¸âƒ£ Recovery Simulation</h3>`;

        let foundOrderData = null;

        // Pas 1: SessionStorage (prioritate maximÄƒ)
        if (sessionBackup) {
          try {
            const backupData = JSON.parse(sessionBackup);
            if (backupData.orderId === urlOrderId) {
              foundOrderData = {
                orderNumber: backupData.orderId,
                customerName: `${backupData.customerInfo.firstName} ${backupData.customerInfo.lastName}`,
                customerEmail: backupData.customerInfo.email,
                customerPhone: backupData.customerInfo.phone,
                customerAddress: backupData.customerInfo.address,
                customerCity: backupData.customerInfo.city,
                customerCounty: backupData.customerInfo.county,
                totalAmount: backupData.amount,
                paymentMethod: "Card bancar (NETOPIA Payments)",
                date: backupData.timestamp || new Date().toISOString(),
                items: [
                  {
                    name: backupData.description,
                    price: backupData.amount,
                    quantity: 1,
                  },
                ],
                isRealUserData: true,
              };
              html += `<p class="success">âœ… Date recuperate din sessionStorage!</p>`;
            }
          } catch (error) {
            html += `<p class="error">âŒ Eroare recuperare sessionStorage: ${error.message}</p>`;
          }
        }

        if (foundOrderData) {
          html += `<div class="success">
            <h4>ğŸ‰ DATE RECUPERATE CU SUCCES!</h4>
            <p>ğŸ“‹ OrderNumber: ${foundOrderData.orderNumber}</p>
            <p>ğŸ‘¤ Nume: ${foundOrderData.customerName}</p>
            <p>ğŸ“§ Email: ${foundOrderData.customerEmail}</p>
            <p>ğŸ“± Telefon: ${foundOrderData.customerPhone}</p>
            <p>ğŸ  AdresÄƒ: ${foundOrderData.customerAddress}, ${foundOrderData.customerCity}</p>
            <p>ğŸ’° Total: ${foundOrderData.totalAmount} RON</p>
            <p>ğŸ·ï¸ Date reale: ${foundOrderData.isRealUserData ? "DA" : "NU"}</p>
        </div>`;

          // Test email
          html += `<div class="test-section">
            <h3>5ï¸âƒ£ Email Test</h3>
            <button onclick="testEmailSend('${foundOrderData.customerEmail}', '${foundOrderData.orderNumber}')">
                ğŸ“§ Test Email cÄƒtre ${foundOrderData.customerEmail}
            </button>
            <div id="emailResult"></div>
        </div>`;
        } else {
          html += `<div class="error">
            <h4>âŒ NU S-AU GÄ‚SIT DATE!</h4>
            <p>Motivele posibile:</p>
            <ul>
                <li>OrderID nu se potriveÈ™te</li>
                <li>SessionStorage backup lipsÄƒ</li>
                <li>Eroare de parsare</li>
            </ul>
        </div>`;
        }

        html += `</div>`;

        results.innerHTML = html;
      }

      async function testEmailSend(email, orderNumber) {
        const resultDiv = document.getElementById("emailResult");
        resultDiv.innerHTML = "ğŸ“§ Se trimite email...";

        // SimuleazÄƒ trimiterea emailului
        const emailData = {
          orderData: {
            email: email,
            customerName: "Alexandra Georgescu", // Din datele de test
            firstName: "Alexandra",
            lastName: "Georgescu",
            phone: "0742567890",
            address: "Bulevardul Unirii 45",
            city: "BucureÈ™ti",
            county: "BucureÈ™ti",
            totalAmount: "199.99",
            items: [{ name: "Test Emblem", price: "199.99", quantity: 1 }],
            paymentMethod: "Card bancar (NETOPIA Payments)",
            date: new Date().toISOString(),
            isBackupNotification: false,
          },
          orderNumber: orderNumber,
          totalAmount: "199.99",
        };

        try {
          const response = await fetch("/.netlify/functions/send-order-email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(emailData),
          });

          const result = await response.json();

          if (result.success) {
            resultDiv.innerHTML = `<div class="success">
                âœ… Email trimis cu succes!<br>
                ğŸ“§ CÄƒtre: ${email}<br>
                ğŸ“‹ OrderID: ${result.customerEmailId}
            </div>`;
          } else {
            resultDiv.innerHTML = `<div class="error">âŒ Eroare: ${result.error}</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="error">âŒ Network error: ${error.message}</div>`;
        }
      }

      // Auto-run debug
      window.onload = debugRealDataRecovery;
    </script>
  </body>
</html>
