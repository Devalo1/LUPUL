<!doctype html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Email Duplicate Fix</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .results {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        color: #28a745;
      }
      .warning {
        color: #ffc107;
      }
      .error {
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>ğŸ§ª Test Email Duplicate Fix</h1>
      <p>
        Acest test va simula o comandÄƒ cu platÄƒ cu cardul È™i va verifica dacÄƒ se
        trimite doar un email Ã®n loc de 3.
      </p>

      <button onclick="setupTestOrder()">1. ğŸ“‹ Setup Date Test ComandÄƒ</button>
      <button onclick="simulateOrderConfirmation()">
        2. ğŸ”„ SimuleazÄƒ OrderConfirmation
      </button>
      <button onclick="checkServerLogs()">3. ğŸ“Š VerificÄƒ Log-uri Server</button>
      <button onclick="clearStorage()">4. ğŸ§¹ CurÄƒÈ›Äƒ Storage</button>

      <div id="results" class="results"></div>
    </div>

    <script>
      let testOrderId = "LC-TEST-" + Date.now();

      function log(message, type = "info") {
        const results = document.getElementById("results");
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          info: "#000",
          success: "#28a745",
          warning: "#ffc107",
          error: "#dc3545",
        };

        results.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
        results.scrollTop = results.scrollHeight;
      }

      function setupTestOrder() {
        log("ğŸš€ Setup-ing date test pentru CommandID: " + testOrderId, "info");

        // SimuleazÄƒ date reale Ã®n sessionStorage (cele mai importante)
        const realOrderData = {
          orderId: testOrderId,
          customerInfo: {
            firstName: "Test",
            lastName: "User",
            email: "test@example.com",
            phone: "0700000000",
            address: "Strada Test 123",
            city: "BucureÈ™ti",
            county: "BucureÈ™ti",
          },
          amount: 299.99,
          description: "Test Emblem Digital",
          timestamp: new Date().toISOString(),
        };

        sessionStorage.setItem(
          "currentOrderBackup",
          JSON.stringify(realOrderData)
        );
        log("âœ… Date reale salvate Ã®n sessionStorage", "success");

        // AdaugÄƒ È™i Ã®n localStorage pentru backup
        const pendingOrders = {};
        pendingOrders[testOrderId] = {
          orderNumber: testOrderId,
          customerName: "Test User",
          customerEmail: "test@example.com",
          customerPhone: "0700000000",
          customerAddress: "Strada Test 123",
          customerCity: "BucureÈ™ti",
          customerCounty: "BucureÈ™ti",
          totalAmount: 299.99,
          paymentMethod: "Card bancar (NETOPIA Payments)",
          date: new Date().toISOString(),
          items: [{ name: "Test Emblem Digital", price: 299.99, quantity: 1 }],
          isRealUserData: true,
        };

        localStorage.setItem("pendingOrders", JSON.stringify(pendingOrders));
        log("âœ… Date backup salvate Ã®n localStorage", "success");
        log("ğŸ“‹ Test setup complet pentru: " + testOrderId, "success");
      }

      async function simulateOrderConfirmation() {
        log(
          "ğŸ”„ Simulez accesarea OrderConfirmation cu date duplicate...",
          "info"
        );

        // Deschide OrderConfirmation cu parametrii testului
        const orderConfirmationUrl = `http://localhost:8888/order-confirmation?orderId=${testOrderId}&status=paid`;

        log("ğŸŒ Deschid OrderConfirmation: " + orderConfirmationUrl, "info");

        // Deschide Ã®n fereastrÄƒ nouÄƒ pentru a putea urmÄƒri
        const newWindow = window.open(
          orderConfirmationUrl,
          "_blank",
          "width=800,height=600"
        );

        if (newWindow) {
          log("âœ… OrderConfirmation deschis Ã®n fereastrÄƒ nouÄƒ", "success");
          log(
            "ğŸ‘€ UrmÄƒriÈ›i consola din fereastra nouÄƒ pentru log-uri",
            "warning"
          );
          log("ğŸ“§ VerificaÈ›i dacÄƒ se trimite doar UN email, nu 3", "warning");
        } else {
          log(
            "âŒ Nu s-a putut deschide fereastra nouÄƒ (popup blocker?)",
            "error"
          );
        }
      }

      async function checkServerLogs() {
        log(
          "ğŸ“Š Verific log-urile serverului pentru trimiteri duplicate...",
          "info"
        );

        try {
          // Simulated - Ã®n practicÄƒ serverul va afiÈ™a log-urile Ã®n terminal
          log("ğŸ“‹ Pentru a vedea log-urile reale:", "info");
          log("1. VerificaÈ›i terminalul unde ruleazÄƒ `npm run dev`", "warning");
          log("2. CÄƒutaÈ›i log-uri pentru: " + testOrderId, "warning");
          log("3. VerificaÈ›i dacÄƒ apare doar UN email trimis", "warning");
          log(
            '4. CÄƒutaÈ›i mesaje: "âš ï¸ Email deja trimis sau Ã®n curs de trimitere"',
            "success"
          );
        } catch (error) {
          log("âŒ Eroare la verificarea log-urilor: " + error.message, "error");
        }
      }

      function clearStorage() {
        sessionStorage.clear();
        localStorage.clear();
        document.getElementById("results").innerHTML = "";
        log("ğŸ§¹ Storage curÄƒÈ›at È™i rezultate resetate", "success");
      }

      // Auto-setup la Ã®ncÄƒrcare
      window.onload = function () {
        log("ğŸ§ª Test Email Duplicate Fix iniÈ›ializat", "success");
        log("ğŸ“ InstrucÈ›iuni:", "info");
        log(
          '1. ApÄƒsaÈ›i "Setup Date Test ComandÄƒ" pentru a pregÄƒti datele',
          "info"
        );
        log('2. ApÄƒsaÈ›i "SimuleazÄƒ OrderConfirmation" pentru a testa', "info");
        log(
          "3. UrmÄƒriÈ›i log-urile Ã®n terminal È™i consola browser-ului",
          "info"
        );
        log("4. VerificaÈ›i cÄƒ se trimite doar UN email, nu 3", "warning");
      };
    </script>
  </body>
</html>
