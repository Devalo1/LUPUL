<!doctype html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ”„ Test Final Recovery System</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      h1 {
        color: #ffd700;
        text-align: center;
      }
      h2 {
        color: #90ee90;
        border-bottom: 2px solid #90ee90;
        padding-bottom: 10px;
      }
      .btn {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        border: none;
        color: white;
        padding: 15px 30px;
        margin: 10px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: all 0.3s ease;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .test-section {
        background: rgba(0, 0, 0, 0.2);
        padding: 20px;
        margin: 15px 0;
        border-radius: 10px;
        border-left: 4px solid #ffd700;
      }
      .result {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        border-left: 4px solid #4caf50;
      }
      .error {
        border-left: 4px solid #f44336;
      }
      .warning {
        border-left: 4px solid #ff9800;
      }
      .info {
        border-left: 4px solid #2196f3;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”„ Test Final Recovery System - SoluÈ›ia CompletÄƒ</h1>

    <div class="container">
      <h2>ğŸ¯ TesteazÄƒ Ã®ntregul flow de recovery</h2>
      <p>
        Acest test verificÄƒ dacÄƒ recovery system-ul poate salva emailurile cÃ¢nd
        localStorage se pierde.
      </p>

      <div class="test-section">
        <h3>ğŸš€ Test Complet Automatizat</h3>
        <button class="btn" onclick="runCompleteTest()">
          ğŸ§ª RuleazÄƒ Test Complet
        </button>
        <div id="completeResult" class="result"></div>
      </div>
    </div>

    <div class="container">
      <h2>âš¡ Test Individual</h2>

      <div class="test-section">
        <h3>1ï¸âƒ£ Test API Recovery Direct</h3>
        <button class="btn" onclick="testApiRecovery()">ğŸ” Test API</button>
        <div id="apiResult" class="result"></div>
      </div>

      <div class="test-section">
        <h3>2ï¸âƒ£ Test SessionStorage Recovery</h3>
        <button class="btn" onclick="testSessionStorage()">
          ğŸ’¾ Test SessionStorage
        </button>
        <div id="sessionResult" class="result"></div>
      </div>

      <div class="test-section">
        <h3>3ï¸âƒ£ Test Email prin Recovery</h3>
        <button class="btn" onclick="testEmailWithRecovery()">
          ğŸ“§ Test Email
        </button>
        <div id="emailTestResult" class="result"></div>
      </div>
    </div>

    <script>
      const TEST_ORDER_ID = "LC-" + Date.now();

      async function runCompleteTest() {
        const result = document.getElementById("completeResult");
        result.innerHTML = "ğŸ§ª Se ruleazÄƒ testul complet...\n\n";
        result.className = "result info";

        let testLog = "ğŸ”„ TEST COMPLET RECOVERY SYSTEM\n";
        testLog += "=====================================\n\n";

        try {
          // Pasul 1: SimuleazÄƒ salvarea datelor
          testLog += "ğŸ“‹ PASUL 1: Simulare salvare date Ã®n PaymentPage\n";
          const testData = {
            orderId: TEST_ORDER_ID,
            amount: "99.99",
            description: "Test Recovery Purchase",
            customerInfo: {
              firstName: "Ion",
              lastName: "Recovery",
              email: "ion.recovery@test.com",
              phone: "0712345678",
              address: "Strada Recovery 1",
              city: "BucureÈ™ti",
              county: "BucureÈ™ti",
            },
          };

          // SalveazÄƒ Ã®n sessionStorage (backup)
          sessionStorage.setItem(
            "currentOrderBackup",
            JSON.stringify({
              ...testData,
              timestamp: new Date().toISOString(),
              source: "PaymentPage",
            })
          );

          testLog += "âœ… Date salvate Ã®n sessionStorage backup\n\n";

          // Pasul 2: SimuleazÄƒ pierderea localStorage
          testLog += "ğŸ“‹ PASUL 2: Simulare pierdere localStorage\n";
          localStorage.removeItem("currentOrder");
          localStorage.removeItem("pendingOrder");
          localStorage.removeItem("pendingOrders");
          testLog += "âŒ localStorage.currentOrder: È˜TERS\n";
          testLog += "âŒ localStorage.pendingOrder: È˜TERS\n";
          testLog += "âŒ localStorage.pendingOrders: È˜TERS\n\n";

          // Pasul 3: Test recovery prin sessionStorage
          testLog += "ğŸ“‹ PASUL 3: Test recovery prin sessionStorage\n";
          const sessionBackup = sessionStorage.getItem("currentOrderBackup");
          if (sessionBackup) {
            testLog += "âœ… SessionStorage backup gÄƒsit!\n";
            const backupData = JSON.parse(sessionBackup);
            testLog += `ğŸ“§ Email client: ${backupData.customerInfo.email}\n`;
            testLog += `ğŸ“± Telefon: ${backupData.customerInfo.phone}\n\n`;
          } else {
            testLog += "âŒ SessionStorage backup lipsÄƒ!\n\n";
          }

          // Pasul 4: Test API recovery
          testLog += "ğŸ“‹ PASUL 4: Test API recovery\n";
          try {
            const apiResponse = await fetch(
              `/.netlify/functions/get-order-details?orderId=${TEST_ORDER_ID}`
            );
            const apiResult = await apiResponse.json();

            if (apiResult.success) {
              testLog += "âœ… API Recovery SUCCESS!\n";
              testLog += `ğŸ“§ Email recuperat: ${apiResult.orderData.customerEmail}\n`;
              testLog += `ğŸ‘¤ Nume: ${apiResult.orderData.customerName}\n`;
              testLog += `ğŸ’° SumÄƒ: ${apiResult.orderData.totalAmount} RON\n\n`;
            } else {
              testLog += "âŒ API Recovery FAILED\n";
              testLog += `âŒ Error: ${apiResult.error || "Unknown error"}\n\n`;
            }
          } catch (apiError) {
            testLog += "âŒ API Recovery ERROR\n";
            testLog += `âŒ Error: ${apiError.message}\n\n`;
          }

          // Pasul 5: Test simulare trimitere email
          testLog += "ğŸ“‹ PASUL 5: Test simulare trimitere email\n";
          const orderDataForEmail = sessionBackup
            ? (() => {
                const backup = JSON.parse(sessionBackup);
                return {
                  orderNumber: backup.orderId,
                  customerName: `${backup.customerInfo.firstName} ${backup.customerInfo.lastName}`,
                  customerEmail: backup.customerInfo.email,
                  customerPhone: backup.customerInfo.phone,
                  customerAddress: backup.customerInfo.address,
                  customerCity: backup.customerInfo.city,
                  customerCounty: backup.customerInfo.county,
                  totalAmount: backup.amount,
                  paymentMethod: "Card bancar (NETOPIA Payments) - RECOVERY",
                  date: backup.timestamp,
                  items: [
                    {
                      name: backup.description,
                      price: backup.amount,
                      quantity: 1,
                    },
                  ],
                };
              })()
            : null;

          if (orderDataForEmail) {
            testLog += "âœ… Date pentru email preparate din recovery!\n";
            testLog += `ğŸ“§ Destinatar: ${orderDataForEmail.customerEmail}\n`;
            testLog += `ğŸ“‹ ComandÄƒ: ${orderDataForEmail.orderNumber}\n`;
            testLog += `ğŸ’° SumÄƒ: ${orderDataForEmail.totalAmount} RON\n\n`;

            // Simulare trimitere email (fÄƒrÄƒ sÄƒ trimitem real)
            testLog += "ğŸ“§ SIMULARE: Email ar fi trimis cu urmÄƒtoarele date:\n";
            testLog += `   TO: ${orderDataForEmail.customerEmail}\n`;
            testLog += `   SUBJECT: Confirmare comandÄƒ ${orderDataForEmail.orderNumber}\n`;
            testLog += `   CONTENT: Detalii comandÄƒ, sumÄƒ ${orderDataForEmail.totalAmount} RON\n\n`;
          } else {
            testLog += "âŒ Nu s-au gÄƒsit date pentru email!\n\n";
          }

          // Concluzie
          testLog += "ğŸ¯ CONCLUZIE FINALÄ‚:\n";
          testLog += "=====================================\n";

          const sessionWorks = !!sessionBackup;
          const hasEmailData = !!orderDataForEmail;

          if (sessionWorks && hasEmailData) {
            testLog += "ğŸ‰ SUCCESS! Recovery system funcÈ›ioneazÄƒ perfect!\n";
            testLog +=
              "âœ… Chiar dacÄƒ localStorage se pierde, emailul va fi trimis\n";
            testLog += "âœ… SessionStorage backup salveazÄƒ situaÈ›ia\n";
            testLog += "âœ… Datele sunt complete pentru trimiterea emailului\n";
            result.className = "result success";
          } else {
            testLog += "âŒ FAILED! Recovery system are probleme\n";
            testLog += `âŒ SessionStorage works: ${sessionWorks}\n`;
            testLog += `âŒ Email data available: ${hasEmailData}\n`;
            result.className = "result error";
          }
        } catch (error) {
          testLog += `âŒ EROARE GENERALÄ‚: ${error.message}\n`;
          result.className = "result error";
        }

        result.innerHTML = testLog;
      }

      async function testApiRecovery() {
        const result = document.getElementById("apiResult");
        result.innerHTML = "ğŸ” Se testeazÄƒ API recovery...";

        try {
          const response = await fetch(
            `/.netlify/functions/get-order-details?orderId=${TEST_ORDER_ID}`
          );
          const data = await response.json();

          let output = `ğŸ” TEST API RECOVERY pentru OrderID: ${TEST_ORDER_ID}\n\n`;
          output += `ğŸ“¡ Status Code: ${response.status}\n`;
          output += `ğŸ“¡ Response OK: ${response.ok}\n\n`;

          if (data.success) {
            output += "âœ… API RECOVERY SUCCESS!\n\n";
            output += "ğŸ“‹ Date recuperate:\n";
            output += JSON.stringify(data.orderData, null, 2);
            result.className = "result success";
          } else {
            output += "âŒ API RECOVERY FAILED\n\n";
            output += `âŒ Error: ${data.error}\n`;
            output += `ğŸ” Searched sources: ${JSON.stringify(data.searchedSources)}\n`;
            if (data.recommendation) {
              output += `ğŸ’¡ Recommendation: ${data.recommendation}\n`;
            }
            result.className = "result warning";
          }

          result.innerHTML = output;
        } catch (error) {
          result.innerHTML = `âŒ EROARE API: ${error.message}`;
          result.className = "result error";
        }
      }

      async function testSessionStorage() {
        const result = document.getElementById("sessionResult");

        // SalveazÄƒ date test Ã®n sessionStorage
        const testData = {
          orderId: TEST_ORDER_ID,
          amount: "75.50",
          description: "Test SessionStorage Recovery",
          customerInfo: {
            firstName: "Maria",
            lastName: "SessionTest",
            email: "maria.session@test.com",
            phone: "0723456789",
            address: "Strada Session 2",
            city: "Cluj",
            county: "Cluj",
          },
          timestamp: new Date().toISOString(),
          source: "PaymentPage",
        };

        sessionStorage.setItem("currentOrderBackup", JSON.stringify(testData));

        // TesteazÄƒ recovery
        const recovered = sessionStorage.getItem("currentOrderBackup");

        let output = "ğŸ’¾ TEST SESSIONSTORAGE RECOVERY\n\n";

        if (recovered) {
          const data = JSON.parse(recovered);
          output += "âœ… SessionStorage backup funcÈ›ioneazÄƒ!\n\n";
          output += "ğŸ“‹ Date recuperate:\n";
          output += `OrderID: ${data.orderId}\n`;
          output += `Email: ${data.customerInfo.email}\n`;
          output += `Nume: ${data.customerInfo.firstName} ${data.customerInfo.lastName}\n`;
          output += `Telefon: ${data.customerInfo.phone}\n`;
          output += `SumÄƒ: ${data.amount} RON\n`;
          output += `Timestamp: ${data.timestamp}\n\n`;

          // ConverteÈ™te Ã®n formatul pentru OrderConfirmation
          const orderData = {
            orderNumber: data.orderId,
            customerName: `${data.customerInfo.firstName} ${data.customerInfo.lastName}`,
            customerEmail: data.customerInfo.email,
            customerPhone: data.customerInfo.phone,
            customerAddress: data.customerInfo.address,
            customerCity: data.customerInfo.city,
            customerCounty: data.customerInfo.county,
            totalAmount: data.amount,
            paymentMethod: "Card bancar (NETOPIA Payments)",
            date: data.timestamp,
            items: [
              { name: data.description, price: data.amount, quantity: 1 },
            ],
          };

          output += "ğŸ“§ Date pregÄƒtite pentru email:\n";
          output += JSON.stringify(orderData, null, 2);

          result.className = "result success";
        } else {
          output += "âŒ SessionStorage backup nu funcÈ›ioneazÄƒ!";
          result.className = "result error";
        }

        result.innerHTML = output;
      }

      async function testEmailWithRecovery() {
        const result = document.getElementById("emailTestResult");
        result.innerHTML =
          "ğŸ“§ Se testeazÄƒ trimiterea emailului prin recovery...";

        try {
          // ÃncearcÄƒ sÄƒ obÈ›inÄƒ date din sessionStorage
          const sessionBackup = sessionStorage.getItem("currentOrderBackup");

          if (!sessionBackup) {
            result.innerHTML =
              "âŒ Nu existÄƒ date Ã®n sessionStorage pentru test email!";
            result.className = "result error";
            return;
          }

          const backupData = JSON.parse(sessionBackup);

          // PregÄƒteÈ™te datele pentru email
          const emailData = {
            orderData: {
              email: backupData.customerInfo.email,
              customerName: `${backupData.customerInfo.firstName} ${backupData.customerInfo.lastName}`,
              firstName: backupData.customerInfo.firstName,
              lastName: backupData.customerInfo.lastName,
              phone: backupData.customerInfo.phone,
              address: backupData.customerInfo.address,
              city: backupData.customerInfo.city,
              county: backupData.customerInfo.county,
              totalAmount: backupData.amount,
              items: [
                {
                  name: backupData.description,
                  price: backupData.amount,
                  quantity: 1,
                },
              ],
              paymentMethod: "Card bancar (NETOPIA Payments) - RECOVERY TEST",
              date: backupData.timestamp,
              isBackupNotification: false,
            },
            orderNumber: backupData.orderId,
            totalAmount: backupData.amount,
          };

          let output = "ğŸ“§ TEST TRIMITERE EMAIL PRIN RECOVERY\n\n";
          output += "ğŸ“‹ Date email pregÄƒtite:\n";
          output += `TO: ${emailData.orderData.email}\n`;
          output += `Order: ${emailData.orderNumber}\n`;
          output += `Amount: ${emailData.totalAmount} RON\n`;
          output += `Customer: ${emailData.orderData.customerName}\n\n`;

          // Trimite emailul REAL
          const emailResponse = await fetch(
            "/.netlify/functions/send-order-email",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(emailData),
            }
          );

          const emailResult = await emailResponse.json();

          output += `ğŸ“¡ Email Response Status: ${emailResponse.status}\n`;
          output += `ğŸ“¡ Email Response OK: ${emailResponse.ok}\n\n`;

          if (emailResult.success) {
            output += "ğŸ‰ EMAIL TRIMIS CU SUCCES PRIN RECOVERY!\n\n";
            output += "âœ… Recovery system funcÈ›ioneazÄƒ perfect!\n";
            output +=
              "âœ… Chiar dacÄƒ localStorage se pierde, emailul ajunge la client!\n";
            output += `âœ… Email trimis cÄƒtre: ${emailData.orderData.email}\n`;
            output += `âœ… Pentru comanda: ${emailData.orderNumber}\n`;
            result.className = "result success";
          } else {
            output += "âŒ EMAIL NU A FOST TRIMIS!\n\n";
            output += `âŒ Error: ${emailResult.error}\n`;
            output += `âŒ Details: ${JSON.stringify(emailResult, null, 2)}`;
            result.className = "result error";
          }

          result.innerHTML = output;
        } catch (error) {
          result.innerHTML = `âŒ EROARE TEST EMAIL: ${error.message}`;
          result.className = "result error";
        }
      }

      // Auto-run test on page load
      window.onload = function () {
        console.log(
          "ğŸ”„ Final Recovery Test Page loaded - Ready for comprehensive testing!"
        );

        // AfiÈ™eazÄƒ un mesaj de bun venit
        setTimeout(() => {
          const completeResult = document.getElementById("completeResult");
          completeResult.innerHTML = `ğŸ”„ Ready pentru testarea completÄƒ a recovery system-ului!

ğŸ¯ Acest test va simula:
   1. Salvarea datelor Ã®n PaymentPage  
   2. Pierderea localStorage (problema curentÄƒ)
   3. Recovery prin sessionStorage backup
   4. Recovery prin API (ca fallback)
   5. Trimiterea emailului prin recovery

ğŸš€ ApasÄƒ "RuleazÄƒ Test Complet" pentru a Ã®ncepe!`;
          completeResult.className = "result info";
        }, 500);
      };
    </script>
  </body>
</html>
