<!doctype html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ”§ Test COMPLET - Fix Email OrderConfirmation</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .success {
        color: #22c55e;
        font-weight: bold;
      }
      .error {
        color: #ef4444;
        font-weight: bold;
      }
      .warning {
        color: #f59e0b;
        font-weight: bold;
      }
      .info {
        color: #3b82f6;
        font-weight: bold;
      }
      pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        border-left: 4px solid #3b82f6;
        font-size: 12px;
      }
      button {
        background: #3b82f6;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }
      button:hover {
        background: #2563eb;
      }
      .test-button {
        background: #dc2626;
        font-size: 18px;
        padding: 15px 30px;
        margin: 10px;
      }
      .test-button:hover {
        background: #b91c1c;
      }
      .backup-button {
        background: #f59e0b;
      }
      .backup-button:hover {
        background: #d97706;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .full-width {
        grid-column: 1 / -1;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”§ Test COMPLET - Fix Email OrderConfirmation</h1>
    <p class="info">
      TesteazÄƒ toate scenario-urile pentru problema cu emailurile de confirmare
      dupÄƒ plata cu cardul
    </p>

    <div class="container full-width">
      <h2>ğŸš€ TESTE RAPIDE</h2>
      <div style="display: flex; flex-wrap: wrap; gap: 10px">
        <button class="test-button" onclick="testScenario1()">
          âœ… Scenario 1: Date Normale
        </button>
        <button class="test-button backup-button" onclick="testScenario2()">
          âš ï¸ Scenario 2: LocalStorage Gol
        </button>
        <button class="test-button backup-button" onclick="testScenario3()">
          ğŸ”„ Scenario 3: Doar SessionStorage
        </button>
        <button class="test-button" onclick="openRealOrderConfirmation()">
          ğŸŒ Test Real OrderConfirmation
        </button>
      </div>
    </div>

    <div class="grid">
      <div class="container">
        <h2>ğŸ“Š Status Storage</h2>
        <button onclick="checkAllStorage()">ğŸ‘€ VerificÄƒ Storage</button>
        <button onclick="clearAllStorage()">ğŸ§¹ CurÄƒÈ›Äƒ Tot</button>
        <div id="storageStatus"></div>
      </div>

      <div class="container">
        <h2>ğŸ”§ AcÈ›iuni Manuale</h2>
        <button onclick="setupNormalData()">ğŸ“¦ PregÄƒteÈ™te Date Normale</button>
        <button onclick="setupBackupData()">ğŸ’¾ PregÄƒteÈ™te Doar Backup</button>
        <button onclick="setupNoData()">âŒ È˜terge Toate Datele</button>
      </div>
    </div>

    <div class="container full-width">
      <h2>ğŸ“‹ Rezultate Teste</h2>
      <div id="results">
        <p class="info">Rezultatele testelor vor apÄƒrea aici...</p>
      </div>
    </div>

    <script>
      const orderId = "LC-1753821925911";
      const results = document.getElementById("results");
      const storageStatus = document.getElementById("storageStatus");

      function log(message, type = "info") {
        const className = type;
        const timestamp = new Date().toLocaleTimeString();
        results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        console.log(`[${timestamp}] ${message}`);
      }

      function logStorage(message, type = "info") {
        const className = type;
        const timestamp = new Date().toLocaleTimeString();
        storageStatus.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      }

      function clearAllStorage() {
        localStorage.clear();
        sessionStorage.clear();
        storageStatus.innerHTML = "";
        logStorage("ğŸ§¹ Toate storage-urile au fost curÄƒÈ›ate", "success");
        checkAllStorage();
      }

      function checkAllStorage() {
        storageStatus.innerHTML = "";
        logStorage("ğŸ“‹ Status storage complet:", "info");

        // localStorage
        logStorage(`ğŸ“¦ localStorage (${localStorage.length} items):`, "info");
        if (localStorage.length === 0) {
          logStorage("   âŒ Gol", "warning");
        } else {
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            logStorage(
              `   ğŸ“‹ "${key}": ${value ? value.substring(0, 100) + "..." : "null"}`,
              "info"
            );
          }
        }

        // sessionStorage
        logStorage(
          `ğŸ’¾ sessionStorage (${sessionStorage.length} items):`,
          "info"
        );
        if (sessionStorage.length === 0) {
          logStorage("   âŒ Gol", "warning");
        } else {
          for (let i = 0; i < sessionStorage.length; i++) {
            const key = sessionStorage.key(i);
            const value = sessionStorage.getItem(key);
            logStorage(
              `   ğŸ“‹ "${key}": ${value ? value.substring(0, 100) + "..." : "null"}`,
              "info"
            );
          }
        }
      }

      function setupNormalData() {
        const testCurrentOrder = {
          orderId: orderId,
          amount: "50.00",
          description: "EmblemÄƒ DigitalÄƒ Lupul È™i Corbul",
          customerInfo: {
            firstName: "Test",
            lastName: "Client",
            email: "test@example.com",
            phone: "0700123456",
            address: "Strada Test 123",
            city: "BucureÈ™ti",
            county: "BucureÈ™ti",
            postalCode: "123456",
          },
        };

        localStorage.setItem("currentOrder", JSON.stringify(testCurrentOrder));
        sessionStorage.setItem(
          "currentOrderBackup",
          JSON.stringify({
            ...testCurrentOrder,
            timestamp: new Date().toISOString(),
            source: "Manual setup",
          })
        );

        logStorage(
          "ğŸ“¦ Date normale salvate Ã®n localStorage È™i sessionStorage",
          "success"
        );
        checkAllStorage();
      }

      function setupBackupData() {
        // È˜terge localStorage dar pÄƒstreazÄƒ sessionStorage
        localStorage.removeItem("currentOrder");

        const backupData = {
          orderId: orderId,
          amount: "50.00",
          description: "EmblemÄƒ DigitalÄƒ Lupul È™i Corbul",
          customerInfo: {
            firstName: "Test",
            lastName: "Backup",
            email: "backup@example.com",
            phone: "0700999888",
            address: "Strada Backup 456",
            city: "Cluj",
            county: "Cluj",
            postalCode: "654321",
          },
          timestamp: new Date().toISOString(),
          source: "Backup manual",
        };

        sessionStorage.setItem(
          "currentOrderBackup",
          JSON.stringify(backupData)
        );

        logStorage("ğŸ’¾ Date backup salvate doar Ã®n sessionStorage", "warning");
        checkAllStorage();
      }

      function setupNoData() {
        localStorage.removeItem("currentOrder");
        sessionStorage.removeItem("currentOrderBackup");

        logStorage("âŒ Toate datele comandÄƒ au fost È™terse", "error");
        checkAllStorage();
      }

      async function testScenario1() {
        log(
          "âœ… TESTEZ SCENARIO 1: Date Normale (localStorage + sessionStorage)",
          "success"
        );
        log("=" + "=".repeat(60), "info");

        // PregÄƒteÈ™te datele
        setupNormalData();
        await new Promise((r) => setTimeout(r, 500));

        // TesteazÄƒ email
        await testEmailWithCurrentData("Scenario 1 - Date Normale");

        log("âœ… Scenario 1 finalizat", "success");
      }

      async function testScenario2() {
        log(
          "âš ï¸ TESTEZ SCENARIO 2: LocalStorage Gol (doar sessionStorage)",
          "warning"
        );
        log("=" + "=".repeat(60), "info");

        // PregÄƒteÈ™te backup
        setupBackupData();
        await new Promise((r) => setTimeout(r, 500));

        // TesteazÄƒ email cu backup
        await testEmailWithCurrentData(
          "Scenario 2 - Backup din sessionStorage"
        );

        log("âš ï¸ Scenario 2 finalizat", "warning");
      }

      async function testScenario3() {
        log(
          "ğŸ”„ TESTEZ SCENARIO 3: FÄƒrÄƒ Date (test backup notification)",
          "error"
        );
        log("=" + "=".repeat(60), "info");

        // È˜terge toate datele
        setupNoData();
        await new Promise((r) => setTimeout(r, 500));

        // TesteazÄƒ emailul de backup
        await testBackupNotification();

        log("ğŸ”„ Scenario 3 finalizat", "error");
      }

      async function testEmailWithCurrentData(scenarioName) {
        try {
          // SimuleazÄƒ logica OrderConfirmation
          let orderData = null;

          // ÃncearcÄƒ localStorage mai Ã®ntÃ¢i
          const currentOrderStr = localStorage.getItem("currentOrder");
          if (currentOrderStr) {
            const currentOrder = JSON.parse(currentOrderStr);
            if (currentOrder.orderId === orderId) {
              orderData = {
                orderNumber: currentOrder.orderId,
                customerEmail: currentOrder.customerInfo?.email,
                customerName:
                  currentOrder.customerInfo?.firstName +
                  " " +
                  currentOrder.customerInfo?.lastName,
                customerPhone: currentOrder.customerInfo?.phone,
                customerAddress: currentOrder.customerInfo?.address,
                customerCity: currentOrder.customerInfo?.city,
                customerCounty: currentOrder.customerInfo?.county,
                totalAmount: currentOrder.amount,
                items: [],
                paymentMethod: "card",
                date: new Date().toISOString(),
              };
              log(`âœ… ${scenarioName}: Date gÄƒsite Ã®n localStorage`, "success");
            }
          }

          // DacÄƒ nu, Ã®ncearcÄƒ sessionStorage
          if (!orderData) {
            const sessionBackupStr =
              sessionStorage.getItem("currentOrderBackup");
            if (sessionBackupStr) {
              const sessionBackup = JSON.parse(sessionBackupStr);
              if (sessionBackup.orderId === orderId) {
                orderData = {
                  orderNumber: sessionBackup.orderId,
                  customerEmail: sessionBackup.customerInfo?.email,
                  customerName:
                    sessionBackup.customerInfo?.firstName +
                    " " +
                    sessionBackup.customerInfo?.lastName,
                  customerPhone: sessionBackup.customerInfo?.phone,
                  customerAddress: sessionBackup.customerInfo?.address,
                  customerCity: sessionBackup.customerInfo?.city,
                  customerCounty: sessionBackup.customerInfo?.county,
                  totalAmount: sessionBackup.amount,
                  items: [],
                  paymentMethod: "card",
                  date: new Date().toISOString(),
                };
                log(
                  `âœ… ${scenarioName}: Date gÄƒsite Ã®n sessionStorage backup`,
                  "success"
                );
              }
            }
          }

          if (orderData && orderData.customerEmail) {
            // PregÄƒteÈ™te payload pentru email
            const emailPayload = {
              orderData: {
                email: orderData.customerEmail,
                customerName: orderData.customerName,
                firstName: orderData.customerName?.split(" ")[0] || "Client",
                lastName:
                  orderData.customerName?.split(" ").slice(1).join(" ") || "",
                phone: orderData.customerPhone,
                address: orderData.customerAddress,
                city: orderData.customerCity,
                county: orderData.customerCounty,
                totalAmount: orderData.totalAmount,
                items: orderData.items || [],
                paymentMethod: "Card bancar (NETOPIA Payments)",
                date: orderData.date,
              },
              orderNumber: orderData.orderNumber,
              totalAmount: orderData.totalAmount,
            };

            log(
              `ğŸ“§ ${scenarioName}: Trimit email cÄƒtre ${emailPayload.orderData.email}`,
              "info"
            );

            // Test real cÄƒtre send-order-email
            const response = await fetch(
              "http://localhost:8888/.netlify/functions/send-order-email",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(emailPayload),
              }
            );

            const data = await response.json();

            if (data.success) {
              log(`ğŸ‰ ${scenarioName}: Email trimis cu succes!`, "success");
              if (data.simulated) {
                log(`âš ï¸ Email simulat (dezvoltare)`, "warning");
              } else {
                log(
                  `ğŸ“§ Email real trimis - Customer: ${data.customerEmailId}`,
                  "info"
                );
                log(
                  `ğŸ“§ Email real trimis - Admin: ${data.adminEmailId}`,
                  "info"
                );
              }
            } else {
              log(`âŒ ${scenarioName}: Eroare email - ${data.error}`, "error");
            }
          } else {
            log(
              `âŒ ${scenarioName}: Nu am gÄƒsit date sau email lipsÄƒ`,
              "error"
            );
          }
        } catch (error) {
          log(`ğŸ’¥ ${scenarioName}: Eroare - ${error.message}`, "error");
        }
      }

      async function testBackupNotification() {
        try {
          log("ğŸ“§ Testez notificarea de backup cÄƒtre admin...", "info");

          const adminNotificationPayload = {
            orderData: {
              email: "lupulsicorbul@gmail.com",
              customerName: "ADMIN NOTIFICATION - Date pierdute",
              firstName: "ADMIN",
              lastName: "NOTIFICATION",
              phone: "N/A",
              address: "N/A",
              city: "N/A",
              county: "N/A",
              totalAmount: "NECUNOSCUT",
              items: [
                {
                  name: "âš ï¸ ATENÈšIE: ComandÄƒ cu date pierdute",
                  price: 0,
                  quantity: 1,
                  description: `Order ID: ${orderId} - Nu s-au gÄƒsit datele Ã®n localStorage. VerificÄƒ manual Ã®n NETOPIA!`,
                },
              ],
              paymentMethod: "Card bancar (NETOPIA Payments) - DATE PIERDUTE",
              date: new Date().toISOString(),
              isBackupNotification: true, // Flag pentru backend
            },
            orderNumber: `âš ï¸ ${orderId} - DATE PIERDUTE`,
            totalAmount: "NECUNOSCUT",
          };

          const response = await fetch(
            "http://localhost:8888/.netlify/functions/send-order-email",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(adminNotificationPayload),
            }
          );

          const data = await response.json();

          if (data.success) {
            log(
              "ğŸ‰ Notificare backup trimisÄƒ cu succes cÄƒtre admin!",
              "success"
            );
            if (data.backupMode) {
              log("âœ… Modul backup activat corect", "success");
            }
            log(`ğŸ“§ Admin email ID: ${data.adminEmailId}`, "info");
          } else {
            log(`âŒ Eroare notificare backup: ${data.error}`, "error");
          }
        } catch (error) {
          log(`ğŸ’¥ Eroare testare backup: ${error.message}`, "error");
        }
      }

      function openRealOrderConfirmation() {
        // PregÄƒteÈ™te datele pentru test real
        setupNormalData();

        const url = `http://localhost:8888/order-confirmation?orderId=${orderId}`;
        log(`ğŸŒ Deschid OrderConfirmation real: ${url}`, "info");
        log(
          "ğŸ‘€ VerificÄƒ consola din noul tab pentru debugging complet",
          "info"
        );

        window.open(url, "_blank");
      }

      // IniÈ›ializare
      window.onload = function () {
        log("ğŸ”§ PaginÄƒ de test fix Ã®ncÄƒrcatÄƒ", "success");
        log(`ğŸ“‹ Testez pentru Order ID: ${orderId}`, "info");
        checkAllStorage();
      };
    </script>
  </body>
</html>
