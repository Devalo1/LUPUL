<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test NETOPIA Browser Compatibility Fix</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .browser-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: transform 0.2s;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test NETOPIA Browser Compatibility</h1>
            <p>TesteazƒÉ fix-ul pentru problemele CORS √Æn diferite browsere</p>
        </div>

        <div class="browser-info">
            <h3>üåê Informa»õii Browser</h3>
            <p><strong>Browser:</strong> <span id="browserName">-</span></p>
            <p><strong>User Agent:</strong> <span id="userAgent">-</span></p>
            <p><strong>CORS Strict:</strong> <span id="corsStrict">-</span></p>
            <p><strong>URL curent:</strong> <span id="currentUrl">-</span></p>
        </div>

        <div class="test-section">
            <h3>üìã Test 1: Verificare Endpoint NETOPIA</h3>
            <p>TesteazƒÉ dacƒÉ endpoint-ul nou func»õioneazƒÉ pe browser-ul curent</p>
            <button class="test-button" onclick="testNetopiaEndpoint()">
                üîß Test Endpoint Browser Fix
            </button>
            <div id="endpointResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üí≥ Test 2: Simulare PlatƒÉ CompletƒÉ</h3>
            <p>TesteazƒÉ √Æntregul flow de platƒÉ cu date de test</p>
            <button class="test-button" onclick="testFullPayment()">
                üöÄ Test PlatƒÉ CompletƒÉ
            </button>
            <div id="paymentResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîç Test 3: Compara»õie Browsere</h3>
            <p>Afi»ôeazƒÉ comportamentul specific pentru browser-ul curent</p>
            <button class="test-button" onclick="showBrowserBehavior()">
                üìä AnalizeazƒÉ Browser
            </button>
            <div id="browserResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>‚ö° Test 4: Headers CORS</h3>
            <p>VerificƒÉ dacƒÉ headers CORS sunt corect configura»õi</p>
            <button class="test-button" onclick="testCORSHeaders()">
                üõ°Ô∏è Test CORS Headers
            </button>
            <div id="corsResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Detect browser
        function detectBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            
            if (ua.includes('chrome') && ua.includes('brave')) {
                return { name: 'brave', strict: true };
            } else if (ua.includes('firefox')) {
                return { name: 'firefox', strict: true };
            } else if (ua.includes('edg/')) {
                return { name: 'edge', strict: false };
            } else if (ua.includes('chrome')) {
                return { name: 'chrome', strict: false };
            } else if (ua.includes('safari')) {
                return { name: 'safari', strict: true };
            }
            
            return { name: 'unknown', strict: true };
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const browser = detectBrowser();
            
            document.getElementById('browserName').textContent = browser.name.toUpperCase();
            document.getElementById('userAgent').textContent = navigator.userAgent;
            document.getElementById('corsStrict').textContent = browser.strict ? 'DA' : 'NU';
            document.getElementById('currentUrl').textContent = window.location.href;
        });

        // Show loading
        function showLoading(resultId) {
            const resultEl = document.getElementById(resultId);
            resultEl.style.display = 'block';
            resultEl.className = 'result info';
            resultEl.innerHTML = '<div class="loading"></div> Se executƒÉ testul...';
        }

        // Show result
        function showResult(resultId, content, type = 'info') {
            const resultEl = document.getElementById(resultId);
            resultEl.style.display = 'block';
            resultEl.className = `result ${type}`;
            resultEl.textContent = content;
        }

        // Test 1: Endpoint verification
        async function testNetopiaEndpoint() {
            showLoading('endpointResult');
            
            try {
                console.log('üîß Testing NETOPIA browser fix endpoint...');
                
                const testData = {
                    orderId: `TEST-${Date.now()}`,
                    amount: 100, // 1 RON √Æn bani
                    currency: 'RON',
                    description: 'Test platƒÉ browser compatibility',
                    customerInfo: {
                        firstName: 'Test',
                        lastName: 'Browser',
                        email: 'test@lupulsicorbul.com',
                        phone: '+40700000000',
                        address: 'Strada Test 1',
                        city: 'Bucure»ôti',
                        county: 'Bucure»ôti',
                        postalCode: '123456'
                    },
                    live: false // For»õeazƒÉ sandbox pentru test
                };

                const endpoint = window.location.hostname === 'localhost' ? 
                    '/api/netopia-browser-fix' : 
                    '/.netlify/functions/netopia-browser-fix';

                console.log('üìç Using endpoint:', endpoint);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'text/html,application/json,*/*',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify(testData),
                    credentials: 'same-origin'
                });

                const contentType = response.headers.get('content-type') || '';
                const responseText = await response.text();

                let result = `‚úÖ SUCCES - Endpoint func»õioneazƒÉ!\n\n`;
                result += `Status: ${response.status} ${response.statusText}\n`;
                result += `Content-Type: ${contentType}\n`;
                result += `Response Length: ${responseText.length} chars\n\n`;
                
                if (contentType.includes('text/html')) {
                    result += `üìÑ RƒÉspuns HTML (form NETOPIA):\n`;
                    result += `- Con»õine <form>: ${responseText.includes('<form')}\n`;
                    result += `- Con»õine action: ${responseText.includes('action=')}\n`;
                    result += `- Con»õine data: ${responseText.includes('name="data"')}\n`;
                    result += `- Con»õine signature: ${responseText.includes('name="signature"')}\n`;
                    result += `- Browser info: ${responseText.includes('browser-info')}\n`;
                } else {
                    result += `üìÑ RƒÉspuns JSON/Text:\n${responseText.substring(0, 500)}`;
                }

                showResult('endpointResult', result, 'success');

            } catch (error) {
                console.error('‚ùå Test endpoint failed:', error);
                
                let errorResult = `‚ùå EROARE - Endpoint nu func»õioneazƒÉ!\n\n`;
                errorResult += `Error: ${error.message}\n`;
                errorResult += `Browser: ${detectBrowser().name}\n`;
                
                if (error.message.includes('Failed to fetch')) {
                    errorResult += `\nüö® CORS Error - Browser blocheazƒÉ request-ul!\n`;
                    errorResult += `Solu»õii:\n`;
                    errorResult += `- DezactiveazƒÉ ad blockers\n`;
                    errorResult += `- √éncearcƒÉ alt browser\n`;
                    errorResult += `- VerificƒÉ console-ul pentru detalii`;
                }

                showResult('endpointResult', errorResult, 'error');
            }
        }

        // Test 2: Full payment simulation
        async function testFullPayment() {
            showLoading('paymentResult');
            
            try {
                console.log('üöÄ Testing full payment flow...');
                
                // Simulate payment data like in real app
                const paymentData = {
                    orderId: `TEST-FULL-${Date.now()}`,
                    amount: 500, // 5 RON
                    currency: 'RON',
                    description: 'Test comandƒÉ completƒÉ - Browser Fix',
                    customerInfo: {
                        firstName: 'Test',
                        lastName: 'Complete',
                        email: 'test.complete@lupulsicorbul.com',
                        phone: '+40755123456',
                        address: 'Bulevardul Test 123',
                        city: 'Bucure»ôti',
                        county: 'Ilfov',
                        postalCode: '077190'
                    },
                    live: false // Test √Æn sandbox
                };

                const endpoint = window.location.hostname === 'localhost' ? 
                    '/api/netopia-browser-fix' : 
                    '/.netlify/functions/netopia-browser-fix';

                const startTime = Date.now();
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'text/html,application/json,*/*',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify(paymentData),
                    credentials: 'same-origin'
                });

                const endTime = Date.now();
                const responseTime = endTime - startTime;
                const responseText = await response.text();

                let result = `‚úÖ TEST COMPLET REU»òIT!\n\n`;
                result += `üìä Performan»õƒÉ:\n`;
                result += `- Timp rƒÉspuns: ${responseTime}ms\n`;
                result += `- Status: ${response.status}\n`;
                result += `- Content-Type: ${response.headers.get('content-type')}\n\n`;
                
                result += `üìã Detalii platƒÉ:\n`;
                result += `- Order ID: ${paymentData.orderId}\n`;
                result += `- SumƒÉ: ${(paymentData.amount / 100).toFixed(2)} RON\n`;
                result += `- Client: ${paymentData.customerInfo.firstName} ${paymentData.customerInfo.lastName}\n\n`;

                if (response.ok) {
                    if (responseText.includes('payment-simulation')) {
                        result += `üß™ SIMULARE: Redirec»õionare cƒÉtre pagina de test\n`;
                        result += `URL: ${responseText.match(/paymentUrl":"([^"]+)"/)?.[1] || 'N/A'}\n`;
                    } else if (responseText.includes('<form')) {
                        result += `üí≥ NETOPIA FORM: Generat cu succes\n`;
                        result += `- Endpoint NETOPIA: ${responseText.includes('secure.netopia-payments.com') ? '‚úÖ' : '‚ùå'}\n`;
                        result += `- Auto-submit: ${responseText.includes('submit()') ? '‚úÖ' : '‚ùå'}\n`;
                        result += `- Browser detection: ${responseText.includes('browser-info') ? '‚úÖ' : '‚ùå'}\n`;
                    }
                    
                    showResult('paymentResult', result, 'success');
                } else {
                    result = `‚ùå TEST E»òUAT!\n\n`;
                    result += `Status: ${response.status}\n`;
                    result += `Error: ${responseText}\n`;
                    showResult('paymentResult', result, 'error');
                }

            } catch (error) {
                console.error('‚ùå Full payment test failed:', error);
                
                let errorResult = `‚ùå TESTUL COMPLET A E»òUAT!\n\n`;
                errorResult += `Error: ${error.message}\n`;
                errorResult += `Browser: ${detectBrowser().name}\n`;
                errorResult += `Strict CORS: ${detectBrowser().strict}\n\n`;
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorResult += `üö® ProblemƒÉ de conectivitate!\n`;
                    errorResult += `Posibile cauze:\n`;
                    errorResult += `- Server-ul de dezvoltare nu ruleazƒÉ\n`;
                    errorResult += `- Func»õia Netlify nu existƒÉ\n`;
                    errorResult += `- Browser blocheazƒÉ CORS\n`;
                }

                showResult('paymentResult', errorResult, 'error');
            }
        }

        // Test 3: Browser behavior analysis
        function showBrowserBehavior() {
            showLoading('browserResult');
            
            const browser = detectBrowser();
            
            let result = `üîç ANALIZƒÇ BROWSER: ${browser.name.toUpperCase()}\n\n`;
            
            result += `üìä Caracteristici:\n`;
            result += `- Nume: ${browser.name}\n`;
            result += `- CORS Strict: ${browser.strict ? 'DA' : 'NU'}\n`;
            result += `- User Agent: ${navigator.userAgent.substring(0, 80)}...\n\n`;
            
            result += `‚öôÔ∏è Comportament a»ôteptat:\n`;
            
            switch (browser.name) {
                case 'brave':
                    result += `- BlocheazƒÉ CORS agresiv\n`;
                    result += `- NecesitƒÉ headers extin»ôi\n`;
                    result += `- Shield-urile pot bloca requests\n`;
                    result += `- Delay mai mare pentru formulare\n`;
                    result += `- Solu»õie: Endpoint cu CORS complet\n`;
                    break;
                    
                case 'firefox':
                    result += `- CORS strict, dar mai permisiv ca Brave\n`;
                    result += `- VerificƒÉ preflight OPTIONS\n`;
                    result += `- Poate bloca mixed content\n`;
                    result += `- Solu»õie: Headers »ôi credentials corecte\n`;
                    break;
                    
                case 'edge':
                    result += `- CORS mai relaxat\n`;
                    result += `- Compatibil cu Chrome\n`;
                    result += `- Func»õioneazƒÉ cu headers standard\n`;
                    result += `- Procesor rapid pentru formulare\n`;
                    break;
                    
                case 'chrome':
                    result += `- Balansat √Æntre securitate »ôi func»õionalitate\n`;
                    result += `- CORS standard\n`;
                    result += `- Suport excelent pentru fetch API\n`;
                    result += `- Referin»õa pentru compatibilitate\n`;
                    break;
                    
                case 'safari':
                    result += `- CORS »ôi privacy foarte stricte\n`;
                    result += `- Poate bloca third-party cookies\n`;
                    result += `- Restri√ß√µes ITP (Intelligent Tracking Prevention)\n`;
                    result += `- Solu»õie: Same-origin credentials\n`;
                    break;
                    
                default:
                    result += `- Browser necunoscut\n`;
                    result += `- Folosim configura»õia strictƒÉ\n`;
                    result += `- TesteazƒÉ cu browsere mainstream\n`;
            }
            
            result += `\nüîß OptimizƒÉri aplicate:\n`;
            result += `- Headers CORS extin»ôi: ‚úÖ\n`;
            result += `- Credentials same-origin: ‚úÖ\n`;
            result += `- Accept headers multiple: ‚úÖ\n`;
            result += `- Cache-Control no-cache: ‚úÖ\n`;
            result += `- Delay pentru formulare: ${browser.strict ? '3s' : '1.5s'}\n`;
            
            showResult('browserResult', result, 'info');
        }

        // Test 4: CORS headers verification
        async function testCORSHeaders() {
            showLoading('corsResult');
            
            try {
                console.log('üõ°Ô∏è Testing CORS headers...');
                
                const endpoint = window.location.hostname === 'localhost' ? 
                    '/api/netopia-browser-fix' : 
                    '/.netlify/functions/netopia-browser-fix';

                // Test OPTIONS preflight
                const optionsResponse = await fetch(endpoint, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });

                let result = `üõ°Ô∏è TEST CORS HEADERS\n\n`;
                result += `üìã Preflight OPTIONS Request:\n`;
                result += `- Status: ${optionsResponse.status}\n`;
                result += `- Access-Control-Allow-Origin: ${optionsResponse.headers.get('Access-Control-Allow-Origin') || 'MISSING'}\n`;
                result += `- Access-Control-Allow-Methods: ${optionsResponse.headers.get('Access-Control-Allow-Methods') || 'MISSING'}\n`;
                result += `- Access-Control-Allow-Headers: ${optionsResponse.headers.get('Access-Control-Allow-Headers') || 'MISSING'}\n`;
                result += `- Access-Control-Allow-Credentials: ${optionsResponse.headers.get('Access-Control-Allow-Credentials') || 'MISSING'}\n`;
                result += `- Access-Control-Max-Age: ${optionsResponse.headers.get('Access-Control-Max-Age') || 'MISSING'}\n\n`;

                // Test actual POST
                const postResponse = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({ test: true }),
                    credentials: 'same-origin'
                });

                result += `üìã POST Request Headers:\n`;
                result += `- Status: ${postResponse.status}\n`;
                result += `- Access-Control-Allow-Origin: ${postResponse.headers.get('Access-Control-Allow-Origin') || 'MISSING'}\n`;
                result += `- Vary: ${postResponse.headers.get('Vary') || 'MISSING'}\n`;
                result += `- Cache-Control: ${postResponse.headers.get('Cache-Control') || 'MISSING'}\n\n`;

                result += `‚úÖ DIAGNOZA:\n`;
                if (optionsResponse.status === 200 && postResponse.status !== 500) {
                    result += `- CORS configura»õia pare corectƒÉ\n`;
                    result += `- Browser-ul ar trebui sƒÉ accepte requests\n`;
                    if (postResponse.status === 400) {
                        result += `- POST endpoint func»õioneazƒÉ (400 = date invalide, normal pentru test)\n`;
                    }
                } else {
                    result += `- CORS configura»õia are probleme\n`;
                    result += `- Browser-ul poate bloca requests\n`;
                }

                showResult('corsResult', result, optionsResponse.status === 200 ? 'success' : 'error');

            } catch (error) {
                console.error('‚ùå CORS test failed:', error);
                
                let errorResult = `‚ùå TESTUL CORS A E»òUAT!\n\n`;
                errorResult += `Error: ${error.message}\n`;
                errorResult += `Type: ${error.name}\n\n`;
                
                if (error.message.includes('Failed to fetch')) {
                    errorResult += `üö® Browser blocheazƒÉ complet request-urile!\n`;
                    errorResult += `Cauze posibile:\n`;
                    errorResult += `- Ad blocker activ\n`;
                    errorResult += `- Shield-uri browser (Brave)\n`;
                    errorResult += `- Privacy settings stricte\n`;
                    errorResult += `- Server nu ruleazƒÉ\n`;
                }

                showResult('corsResult', errorResult, 'error');
            }
        }

        // Utility to copy result to clipboard
        function copyResult(resultId) {
            const resultEl = document.getElementById(resultId);
            if (resultEl && resultEl.textContent) {
                navigator.clipboard.writeText(resultEl.textContent).then(() => {
                    alert('Rezultatul a fost copiat √Æn clipboard!');
                });
            }
        }
    </script>
</body>
</html>
