<!doctype html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test NETOPIA Flow cu Cookie Recovery</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .results {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        color: #28a745;
      }
      .warning {
        color: #ffc107;
      }
      .error {
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>ğŸ”„ Test NETOPIA Flow cu Cookie Recovery</h1>
      <p>
        Testez Ã®ntregul flow: PaymentPage â†’ NETOPIA â†’ Return â†’ OrderConfirmation
        cu date reale
      </p>

      <button onclick="simulatePaymentPage()">
        1. ğŸ’³ SimuleazÄƒ PaymentPage (salvare date)
      </button>
      <button onclick="simulateNetopiaRedirect()">
        2. ğŸŒ SimuleazÄƒ NETOPIA redirect (pierdere sessionStorage)
      </button>
      <button onclick="simulateReturnAndRecovery()">
        3. ğŸ”™ SimuleazÄƒ Return cu Recovery din Cookie
      </button>
      <button onclick="testOrderConfirmation()">
        4. âœ… Test OrderConfirmation Final
      </button>
      <button onclick="clearAll()">5. ğŸ§¹ Reset</button>

      <div id="results" class="results"></div>
    </div>

    <script>
      const testOrderId = "LC-TEST-COOKIE-" + Date.now();

      function log(message, type = "info") {
        const results = document.getElementById("results");
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          info: "#000",
          success: "#28a745",
          warning: "#ffc107",
          error: "#dc3545",
        };

        results.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
        results.scrollTop = results.scrollHeight;
      }

      function simulatePaymentPage() {
        log("ğŸ’³ PASUL 1: Simulez PaymentPage - salvare date client", "info");

        // SimuleazÄƒ datele din formularul de platÄƒ
        const paymentFormData = {
          firstName: "Dani_popa21",
          lastName: "Lupul",
          email: "dani_popa21@yahoo.ro",
          phone: "0775346243",
          address: "9 MAI BLOC 2 A",
          city: "PETROSANI",
          county: "HUNEDOARA",
          postalCode: "800258",
          amount: "35.00",
          description: "ComandÄƒ Lupul È™i Corbul - 1 produse (35.00 RON)",
        };

        // 1. SalveazÄƒ Ã®n sessionStorage (ca PaymentPage)
        const sessionData = {
          orderId: testOrderId,
          amount: paymentFormData.amount,
          description: paymentFormData.description,
          customerInfo: {
            firstName: paymentFormData.firstName,
            lastName: paymentFormData.lastName,
            email: paymentFormData.email,
            phone: paymentFormData.phone,
            address: paymentFormData.address,
            city: paymentFormData.city,
            county: paymentFormData.county,
            postalCode: paymentFormData.postalCode,
          },
          timestamp: new Date().toISOString(),
          source: "PaymentPage",
        };

        sessionStorage.setItem(
          "currentOrderBackup",
          JSON.stringify(sessionData)
        );
        log("âœ… Date salvate Ã®n sessionStorage", "success");

        // 2. SalveazÄƒ Ã®n cookie (ca PaymentPage)
        const cookieData = {
          orderId: testOrderId,
          email: paymentFormData.email,
          customerName:
            paymentFormData.firstName + " " + paymentFormData.lastName,
          phone: paymentFormData.phone,
          address: paymentFormData.address,
          city: paymentFormData.city,
          county: paymentFormData.county,
          amount: paymentFormData.amount,
          timestamp: new Date().toISOString(),
        };

        const cookieValue = btoa(JSON.stringify(cookieData));
        document.cookie = `orderRecovery_${testOrderId}=${cookieValue}; max-age=86400; path=/; SameSite=Lax`;
        log("âœ… Date salvate Ã®n cookie ca backup", "success");
        log("ğŸ“§ Email client: " + paymentFormData.email, "success");
      }

      function simulateNetopiaRedirect() {
        log(
          "ğŸŒ PASUL 2: Simulez redirect cÄƒtre NETOPIA (pierdere sessionStorage)",
          "warning"
        );

        // SimuleazÄƒ cÄƒ browser-ul È™terge sessionStorage la redirect extern
        sessionStorage.clear();
        log("âš ï¸ SessionStorage È™ters (ca la redirect extern)", "warning");
        log("ğŸª Cookie-ul rÄƒmÃ¢ne intact pentru recovery", "info");
      }

      function simulateReturnAndRecovery() {
        log(
          "ğŸ”™ PASUL 3: Simulez return de la NETOPIA cu recovery din cookie",
          "info"
        );

        // VerificÄƒ dacÄƒ sessionStorage este gol
        const sessionCheck = sessionStorage.getItem("currentOrderBackup");
        if (!sessionCheck) {
          log("âœ… SessionStorage confirmat gol dupÄƒ redirect", "success");

          // SimuleazÄƒ logica din OrderConfirmation pentru recovery din cookie
          const cookieName = `orderRecovery_${testOrderId}`;
          const cookieValue = document.cookie
            .split("; ")
            .find((row) => row.startsWith(cookieName + "="))
            ?.split("=")[1];

          if (cookieValue) {
            const recoveryData = JSON.parse(
              atob(decodeURIComponent(cookieValue))
            );
            log("ğŸª Date gÄƒsite Ã®n cookie!", "success");
            log("ğŸ“§ Email din cookie: " + recoveryData.email, "success");

            // RestaureazÄƒ sessionStorage
            const restoredData = {
              orderId: testOrderId,
              customerInfo: {
                firstName: recoveryData.customerName?.split(" ")[0] || "Client",
                lastName:
                  recoveryData.customerName?.split(" ").slice(1).join(" ") ||
                  "Recuperat",
                email: recoveryData.email,
                phone: recoveryData.phone,
                address: recoveryData.address,
                city: recoveryData.city,
                county: recoveryData.county,
              },
              amount: parseFloat(recoveryData.amount),
              description: "ComandÄƒ Lupul È™i Corbul - Recuperat din cookie",
              timestamp: recoveryData.timestamp,
              source: "CookieRecovery",
            };

            sessionStorage.setItem(
              "currentOrderBackup",
              JSON.stringify(restoredData)
            );
            log("âœ… SessionStorage restaurat cu succes!", "success");
            log(
              "ğŸ‘¤ Nume: " +
                restoredData.customerInfo.firstName +
                " " +
                restoredData.customerInfo.lastName,
              "success"
            );
          } else {
            log("âŒ Nu existÄƒ cookie pentru recovery!", "error");
          }
        } else {
          log("âš ï¸ SessionStorage nu era gol", "warning");
        }
      }

      function testOrderConfirmation() {
        log("âœ… PASUL 4: Test OrderConfirmation cu date recuperate", "info");

        // VerificÄƒ dacÄƒ datele sunt disponibile
        const sessionData = sessionStorage.getItem("currentOrderBackup");
        if (sessionData) {
          const data = JSON.parse(sessionData);
          log("ğŸ¯ Date gÄƒsite pentru OrderConfirmation:", "success");
          log("- OrderID: " + data.orderId, "success");
          log("- Email REAL: " + data.customerInfo.email, "success");
          log(
            "- Nume: " +
              data.customerInfo.firstName +
              " " +
              data.customerInfo.lastName,
            "success"
          );
          log("- Telefon: " + data.customerInfo.phone, "success");
          log("- Suma: " + data.amount + " RON", "success");

          // TesteazÄƒ OrderConfirmation
          const orderConfirmationUrl = `http://localhost:8888/order-confirmation?orderId=${testOrderId}&status=paid`;
          log("ğŸŒ Deschid OrderConfirmation:", "info");
          log(orderConfirmationUrl, "info");

          window.open(orderConfirmationUrl, "_blank", "width=800,height=600");
          log(
            "âœ… OrderConfirmation deschis - ar trebui sÄƒ afiÈ™eze date REALE!",
            "success"
          );
        } else {
          log(
            "âŒ Nu existÄƒ date Ã®n sessionStorage pentru OrderConfirmation!",
            "error"
          );
        }
      }

      function clearAll() {
        sessionStorage.clear();
        localStorage.clear();
        // È˜terge toate cookie-urile de test
        document.cookie.split(";").forEach(function (c) {
          document.cookie = c
            .replace(/^ +/, "")
            .replace(
              /=.*/,
              "=;expires=" + new Date().toUTCString() + ";path=/"
            );
        });
        document.getElementById("results").innerHTML = "";
        log("ğŸ§¹ Toate datele au fost curÄƒÈ›ate", "success");
      }

      // Auto-setup la Ã®ncÄƒrcare
      window.onload = function () {
        log("ğŸ”„ Test NETOPIA Flow cu Cookie Recovery iniÈ›ializat", "success");
        log("ğŸ¯ Test OrderID: " + testOrderId, "info");
        log("ğŸ“ PaÈ™i pentru testare:", "info");
        log("1. SimuleazÄƒ salvarea datelor Ã®n PaymentPage", "info");
        log(
          "2. SimuleazÄƒ pierderea sessionStorage la redirect NETOPIA",
          "info"
        );
        log("3. SimuleazÄƒ recovery din cookie la return", "info");
        log("4. TesteazÄƒ OrderConfirmation cu datele recuperate", "info");
      };
    </script>
  </body>
</html>
